<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<sqlGroup name="modulelist">
	<!-- 统计模具的进度 mysql -->
	<sql id="findModuleSchedule" database="mysqldialect">
	<![CDATA[
		SELECT F.SHORTNAME, ML.MODULECODE, ML.GUESTID, ML.MODULECLASS, ML.STARTTIME
			, ML.INITTRYTIME, ML.MODULESTATE, ML.PRODUCTNAME, ML.MODULEINTRO, ML.WORKPRESSURE
			, ML.UNITEXTRAC, ML.MODULEBARCODE, MR.ID, ML.PLASTIC, (
				SELECT CASE WHEN SUM(IFNULL(DURATION, 0)) = 0 THEN 0 ELSE ROUND(SUM(CASE WHEN STARTTIME <= SYSDATE()
					AND ENDTIME <= SYSDATE() THEN IFNULL(DURATION, 0) WHEN STARTTIME <= SYSDATE()
					AND ENDTIME > SYSDATE() THEN (SYSDATE() - STARTTIME) * 24 ELSE 0 END) / SUM(IFNULL(DURATION, 0)) * 100, 1) END
				FROM MD_EST_SCHEDULE
				WHERE MODULERESUMEID = MR.ID
					AND PARENTID IS NOT NULL
					AND TYPEID IS NULL
				) AS SCHEDULE
			, (
				SELECT CASE WHEN IFNULL((
						SELECT IFNULL(SUM(IFNULL(EVALUATE, DURATION)), 0)
						FROM MD_EST_SCHEDULE
						WHERE MODULERESUMEID = MR.ID
							AND PARENTID IS NOT NULL
							AND TYPEID IS NULL
						), 0) = 0 THEN 0 ELSE IFNULL(ROUND((
						SELECT SUM((IFNULL(NRCDTIME, SYSDATE()) - LRCDTIME) * 24)
						FROM MD_PROCESS_RESUME
						WHERE RSMID = MR.ID
							AND ISTIME = 0
							AND LRCDTIME IS NOT NULL
						) / (
						SELECT IFNULL(SUM(IFNULL(EVALUATE, DURATION)), 0)
						FROM MD_EST_SCHEDULE
						WHERE MODULERESUMEID = MR.ID
							AND PARENTID IS NOT NULL
							AND TYPEID IS NULL
						) * 100, 1), 0) END
				FROM DUAL
				) AS ACTUAL, ROUND((MR.ENDTIME - SYSDATE()) * 24, 1) AS DELAYHOUR
		FROM MD_RESUME MR LEFT JOIN MODULELIST ML ON ML.MODULEBARCODE = MR.MODULEBARCODE
		AND ML.POSID = ? LEFT JOIN FACTORY F ON F.ID = ML.GUESTID
		ORDER BY ML.GUESTID, ML.MODULECODE
		]]>
	</sql>
	
	<!-- 统计模具的进度 oracle -->
	<sql id="findModuleSchedule" database="oracledialect">
	<![CDATA[
		SELECT F.SHORTNAME, ML.MODULECODE, ML.GUESTID, ML.MODULECLASS, ML.STARTTIME
			, ML.INITTRYTIME, ML.MODULESTATE, ML.PRODUCTNAME, ML.MODULEINTRO, ML.WORKPRESSURE
			, ML.UNITEXTRAC, ML.MODULEBARCODE, MR.ID, ML.PLASTIC, (
				SELECT CASE WHEN SUM(NVL(DURATION, 0)) = 0 THEN 0 ELSE ROUND(SUM(CASE WHEN STARTTIME <= SYSDATE
					AND ENDTIME <= SYSDATE THEN NVL(DURATION, 0) WHEN STARTTIME <= SYSDATE
					AND ENDTIME > SYSDATE THEN (SYSDATE - STARTTIME) * 24 ELSE 0 END) / SUM(NVL(DURATION, 0)) * 100, 1) END
				FROM MD_EST_SCHEDULE
				WHERE MODULERESUMEID = MR.ID
					AND PARENTID IS NOT NULL
					AND TYPEID IS NULL
				) AS SCHEDULE
			, (
				SELECT CASE WHEN NVL((
						SELECT NVL(SUM(NVL(EVALUATE, DURATION)), 0)
						FROM MD_EST_SCHEDULE
						WHERE MODULERESUMEID = MR.ID
							AND PARENTID IS NOT NULL
							AND TYPEID IS NULL
						), 0) = 0 THEN 0 ELSE NVL(ROUND((
						SELECT SUM((NVL(NRCDTIME, SYSDATE) - LRCDTIME) * 24)
						FROM MD_PROCESS_RESUME
						WHERE RSMID = MR.ID
							AND ISTIME = 0
							AND LRCDTIME IS NOT NULL
						) / (
						SELECT NVL(SUM(NVL(EVALUATE, DURATION)), 0)
						FROM MD_EST_SCHEDULE
						WHERE MODULERESUMEID = MR.ID
							AND PARENTID IS NOT NULL
							AND TYPEID IS NULL
						) * 100, 1), 0) END
				FROM DUAL
				) AS ACTUAL, ROUND((MR.ENDTIME - SYSDATE) * 24, 1) AS DELAYHOUR
		FROM MD_RESUME MR LEFT JOIN MODULELIST ML ON ML.MODULEBARCODE = MR.MODULEBARCODE
		AND ML.POSID = ? LEFT JOIN FACTORY F ON F.ID = ML.GUESTID
		ORDER BY ML.GUESTID, ML.MODULECODE
		]]>

	</sql>
</sqlGroup>